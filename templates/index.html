<!doctype html>
<html>
  <head>
    <title>{{tenant.dashboard_title}}</title>
    <link
      rel="shortcut icon"
      href="/static/tenant_logos/{{tenant.tenant_id}}.png"
    />

    {% include("components/common_head.html") %}
    <style>
      {% include("components/common_style.css") %}

      main {
        display: grid;
        grid-gap: 1rem;
        grid-template-columns: 75vh 1fr 75vh;
        grid-template-rows: auto 70vh auto;
        grid-template-areas:
          'map summary summary'
          'map subregionwiseDistribution subregionwiseDistribution'
          'trends trends featureDistributions'
        ;
        padding: 1rem max(2rem, calc(50vw - 640px));
      }

      .component-card {
        box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.08), 0px 1px 4px 0px rgba(69, 75, 87, 0.12), 0px 0px 0px 1px rgba(152, 161, 178, 0.10);
        padding: 0.75rem;
        border-radius: 0.5rem;
        background: var(--bg2);
        place-self: stretch;
      }

      .component-card h2 {
        font-size: 1rem;
      }
    </style>
    <script>
      const csrfToken = "{{csrf_token()}}";
      const onDataLoad = [];
      const regionId = location.pathname.split("/").pop();
      const dateSettings = {
        startDate: "",
        endDate: "",
        periodName: "",
      };
      let data;

      const datePresets = [];
      const latestDate = "2024-04-30"; //"{{latest_date}}";
      function computeDatePresets() {
        let today = new Date(latestDate);

        const thisMonthStartDate = new Date(
          today.getFullYear(),
          today.getMonth(),
          1,
        );
        const thisMonthEndDate = new Date(
          today.getFullYear(),
          today.getMonth() + 1,
          0,
        );
        datePresets.push({
          startDate: dateObjToStr(thisMonthStartDate),
          endDate: dateObjToStr(thisMonthEndDate),
          periodName: `${monthShortNames[thisMonthStartDate.getMonth()]} '${(thisMonthStartDate.getFullYear() % 100).toString().padStart(2, "0")}`,
        });

        const lastMonthStartDate = new Date(
          today.getFullYear(),
          today.getMonth() - 1,
          1,
        );
        const lastMonthEndDate = new Date(
          today.getFullYear(),
          today.getMonth(),
          0,
        );
        datePresets.push({
          startDate: dateObjToStr(lastMonthStartDate),
          endDate: dateObjToStr(lastMonthEndDate),
          periodName: `${monthShortNames[lastMonthStartDate.getMonth()]} '${(lastMonthStartDate.getFullYear() % 100).toString().padStart(2, "0")}`,
        });

        const thisYearStartDate = new Date(today.getFullYear(), 0, 1);
        const thisYearEndDate = new Date(today.getFullYear(), 11, 31);
        datePresets.push({
          startDate: dateObjToStr(thisYearStartDate),
          endDate: dateObjToStr(thisYearEndDate),
          periodName: thisYearStartDate.getFullYear().toString(),
        });

        const lastYearStartDate = new Date(today.getFullYear() - 1, 0, 1);
        const lastYearEndDate = new Date(today.getFullYear() - 1, 11, 31);
        datePresets.push({
          startDate: dateObjToStr(lastYearStartDate),
          endDate: dateObjToStr(lastYearEndDate),
          periodName: lastYearStartDate.getFullYear().toString(),
        });
      }

      async function loadData() {
        const response = await fetch("/api/data/query", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken,
          },
          body: JSON.stringify({
            region_id: regionId,
            start_date: dateSettings.startDate,
            end_date: dateSettings.endDate,
            aggregates: [
              "summary",
              "subregionwise_distribution",
              "feature_distributions",
              "trends",
              "predictions",
            ],
          }),
        });
        data = await response.json();
        onDataLoad.forEach((fn) => {
          fn(data);
        });
      }

      window.addEventListener("load", () => {
        computeDatePresets();
        dateSettings.startDate = datePresets[0].startDate;
        dateSettings.endDate = datePresets[0].endDate;
        dateSettings.periodName = datePresets[0].periodName;
        loadData();
      });

      function downloadAsFile(text, filename) {
        var element = document.createElement("a");
        element.setAttribute(
          "href",
          "data:text/plain;charset=utf-8," + encodeURIComponent(text),
        );
        element.setAttribute("download", filename);
        element.style.display = "none";
        document.body.appendChild(element);
        element.click();
        document.body.removeChild(element);
      }

      function getRootCssVar(varName) {
        return getComputedStyle(
          document.querySelector(":root"),
        ).getPropertyValue(varName);
      }

      function dateObjToStr(dateObj) {
        const y = dateObj.getFullYear().toString();
        const m = (dateObj.getMonth() + 1).toString().padStart(2, "0");
        const d = dateObj.getDate().toString().padStart(2, "0");
        return `${y}-${m}-${d}`;
      }

      const monthShortNames = [
        "Jan",
        "Feb",
        "Mar",
        "Apr",
        "May",
        "Jun",
        "Jul",
        "Aug",
        "Sep",
        "Oct",
        "Nov",
        "Dec",
      ];
    </script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="/static/js/papaparse.min.js"></script>
  </head>
  <body>
    {% include("components/header.html") %}
    <!--  -->
    {% include("components/subheader.html") %}
    <main>
      <!-- -->
      {% include("components/map.html") %}
      <!-- -->
      {% include("components/summary.html") %}
      <!-- -->
      {% include("components/feature_distributions.html") %}
      <!-- -->
      {% include("components/subregionwise_distribution.html") %}
      <!-- -->
      {% include("components/trends.html") %}
    </main>
  </body>
</html>
