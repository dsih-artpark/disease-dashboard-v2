<style>
  .component-card.feature-distributions {
    grid-area: featureDistributions;
  }

  .feature-distributions .tabset > div {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    grid-gap: 0.75rem 0.5rem;
    align-content: start;
    font-size: 0.8rem;
    padding: 0.5rem 0;
  }

  .feature-distributions .tabset > div > svg {
    width: 100%;
  }

  .feature-distributions .tabset > div > svg > rect {
    fill: var(--bg-shaded-2);
  }

  .feature-distributions .tabset > div > span {
    text-align: right;
  }
</style>
<div class="component-card feature-distributions">
  <h2>Feature Distributions</h2>
  <div class="tabset">
    <input
      type="radio"
      name="feature-dist-tab"
      value="1"
      id="feature-dist-tab-1"
      checked
    />
    <label for="feature-dist-tab-1">Age</label>
    <div id="cases-by-age_range"></div>

    <input
      type="radio"
      name="feature-dist-tab"
      value="2"
      id="feature-dist-tab-2"
    />
    <label for="feature-dist-tab-2">Gender</label>
    <div id="cases-by-gender"></div>

    <input
      type="radio"
      name="feature-dist-tab"
      value="3"
      id="feature-dist-tab-3"
    />
    <label for="feature-dist-tab-3">Test Type</label>
    <div id="cases-by-test_type"></div>
  </div>
</div>
<script>
  function prepareForBarChart(rows) {
    rows = [...rows]; // cloning without reference

    const knownLabels = {
      "(0, 1]": { label: "0-1", sortKey: 8 },
      "(1, 6]": { label: "1-6", sortKey: 7 },
      "(6, 12]": { label: "6-12", sortKey: 6 },
      "(12, 18]": { label: "12-18", sortKey: 5 },
      "(18, 25]": { label: "18-25", sortKey: 4 },
      "(25, 45]": { label: "25-45", sortKey: 3 },
      "(45, 65]": { label: "45-65", sortKey: 2 },
      "(65, 105]": { label: "65-105", sortKey: 1 },

      FEMALE: { label: "FEMALE", sortKey: 2 },
      MALE: { label: "MALE", sortKey: 1 },

      ns1: { label: "NS1", sortKey: 3 },
      igm: { label: "IgM", sortKey: 2 },
      both: { label: "Both", sortKey: 1 },
    };
    const maxVal = Math.max(...rows.map((row) => row.cases));
    rows.forEach((row) => {
      row.normalizedWidth = (100 * row.cases) / maxVal;
      row.label = row._id;
      row.sortOrder = 0;
      if (row._id in knownLabels) {
        row.sortOrder = knownLabels[row._id].sortKey;
        row.label = knownLabels[row._id].label;
      }
    });
    rows = rows.sort((r1, r2) => r2.sortOrder - r1.sortOrder);
    return rows;
  }

  function renderFeatureDistributions() {
    const keys = ["age_range", "gender", "test_type"];
    keys.forEach((key) => {
      const div = d3.select(`#cases-by-${key}`);
      div.text("");
      const rows = prepareForBarChart(data.feature_distributions[key]);
      rows.forEach((row) => {
        div.append("b").text(row.label);
        div
          .append("svg")
          .attr("viewBox", "0 0 100 3")
          .attr("preseveAspectRatio", "none")
          .append("rect")
          .attr("x", 0)
          .attr("y", 0)
          .attr("width", row.normalizedWidth)
          .attr("height", 3);
        div.append("span").text(row.cases);
      });
    });
  }
  onDataLoad.push(renderFeatureDistributions);
</script>
